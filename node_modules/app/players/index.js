var weaponsModule = require('app/weapons'),
    fs = require('fs'),
    path = require('path'),
    utils = require('app/utils');

function generateGUID() {
    function s4() {
        return Math.floor((1 + Math.random()) * 0x10000)
            .toString(16)
            .substring(1);
    }

    return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
        s4() + '-' + s4() + s4() + s4();
}

module.exports = {
    playersHash: {},
    bots: [],
    isPlayersExists: function(name) {
        return !!this.playersHash[name];
    },
    tryAddPlayer: function(name, country, town, isBot) {
        if(this.isPlayersExists(name)) {
            return {
                success: false
            }
        }
        return {
            success: true,
            playerData: this.addPlayer(name, country, town, isBot)
        }
    },
    addPlayer: function(name, country, town, isBot) {
        var player = {
            name: name,
            key: generateGUID(),
            weaponList: weaponsModule.getWeaponList(),
            hp: 100,
            country: this.getCountry(country),
            town: town,
            lastRequestTime: Date.now(),
            isBot: isBot
        };
        this.playersHash[name] = player;
        if(this.bots.length === 0) {
            this.addBots();
        }
        return player;
    },
    deletePlayer: function(name) {
        delete players[name]
    },
    getCountry: function(country) {
        if(!country) {
            return {
                demonym: 'NoCountry'
            }
        } else {
            return country;
        }
    },
    addBots: function() {
        for(var i = 0; i < 5; i++) {
            this.addBot();
        }
    },
    addBot: function() {
        var me = this;
        fs.readFile(path.join(__dirname, 'randomnicknames.txt'), function(err, data) {
            var names = data.toString().split("\r\n"),
                name = utils.getRandomArrayEntry(names);
            utils.getCountryList(function(countryList) {
                var country = utils.getRandomArrayEntry(countryList),
                    bot = me.tryAddPlayer(name, country, '', true);
                me.bots.push(bot.playerData);
            });
        });
    },
    tryGetGameInfo: function(playerName, playerKey) {
        player = this.playersHash[playerName];
        return {
            playerData: player && player.key === playerKey ? player : null,
            playerList: this.playersHash
        }
    }
};

